/**
 * Export to PDF Plugin for Thymer
 *
 * - Exports the current note via browser print â†’ Save as PDF
 * - Preserves headings and bullet lists
 * - Robust note title extraction (not the collection name)
 * - Chrome-safe printing
 */

class Plugin extends AppPlugin {

	onLoad() {
		this.ui.addCommandPaletteCommand({
			label: "Export to PDF",
			icon: "ti-file-export",
			onSelected: () => this.exportToPDF()
		});
	}

	// Get the current note title
	getNoteTitle() {
		try {
			// First, try editable input/textarea
			const input = document.querySelector(
				'.panel-heading input[type="text"], .panel-heading textarea'
			);
			const inputText = input?.value?.trim();
			if (inputText) return inputText;

			// Next, try a contenteditable node
			const editable = document.querySelector(
				'.panel-heading [contenteditable="true"]'
			);
			const editText = editable?.innerText?.trim();
			if (editText) return editText;

			// Fallback: read the heading container text
			const heading = document.querySelector('.panel-heading');
			if (heading?.innerText?.trim()) {
				let text = heading.innerText.trim();

				// If heading bytes include collection name prefix ("Collection â€” NoteTitle"),
				// split on common separators like ' â€” ' or ' / ' or '|'
				const separators = [' â€” ', ' / ', ' | '];
				for (const sep of separators) {
					if (text.includes(sep)) {
						const parts = text.split(sep).map(s => s.trim()).filter(Boolean);
						if (parts.length > 1) {
							// assume the last part is the actual note title
							text = parts[parts.length - 1];
							break;
						}
					}
				}

				return text;
			}

			return 'Untitled Note';
		} catch {
			return 'Untitled Note';
		}
	}

	getAllContent() {
		try {
			const rows = document.querySelectorAll('.listitem');
			const content = [];

			rows.forEach(row => {
				const textEl =
					row.querySelector('.listitem-content') ||
					row.querySelector('.content') ||
					row;
				const text = textEl.innerText?.trim();
				if (!text) return;

				let type = 'paragraph';
				if (row.classList.contains('listitem-heading')) {
					type = 'heading';
				} else if (row.classList.contains('listitem-ulist')) {
					type = 'ulist';
				}
				content.push({ type, text });
			});

			return content;
		} catch {
			return [];
		}
	}

	exportToPDF() {
		const title = this.getNoteTitle();
		const content = this.getAllContent();

		if (!content.length) {
			this.ui.addToaster({
				title: "âŒ Nothing to export",
				message: "Thymer content could not be detected",
				autoDestroyTime: 2500
			});
			return;
		}

		const container = document.createElement('div');
		container.id = 'thymer-pdf-export';
		container.style.cssText = `
			background: white;
			color: black;
			font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
			font-size: 12pt;
			line-height: 1.6;
			padding: 0.75in;
			max-width: 8.5in;
		`;

		const h1 = document.createElement('h1');
		h1.textContent = title;
		h1.style.marginBottom = '1em';
		container.appendChild(h1);

		let currentUL = null;

		content.forEach(item => {
			if (item.type === 'ulist') {
				if (!currentUL) {
					currentUL = document.createElement('ul');
					currentUL.style.marginBottom = '0.75em';
					container.appendChild(currentUL);
				}
				const li = document.createElement('li');
				li.textContent = item.text;
				currentUL.appendChild(li);
				return;
			}

			currentUL = null;

			if (item.type === 'heading') {
				const h2 = document.createElement('h2');
				h2.textContent = item.text;
				h2.style.margin = '0.8em 0 0.4em';
				container.appendChild(h2);
				return;
			}

			const p = document.createElement('p');
			p.textContent = item.text;
			p.style.marginBottom = '0.5em';
			container.appendChild(p);
		});

		document.body.appendChild(container);

		const style = document.createElement('style');
		style.id = 'thymer-pdf-print-style';
		style.textContent = `
			@media print {
				body > *:not(#thymer-pdf-export) {
					display: none !important;
				}
				#thymer-pdf-export {
					display: block !important;
					position: static;
					width: auto;
				}
				@page { margin: 0.5in; }
			}
		`;
		document.head.appendChild(style);

		this.ui.addToaster({
			title: "ðŸ“„ Exporting to PDF",
			message: "Choose â€œSave as PDFâ€ in the print dialog",
			autoDestroyTime: 3000
		});

		setTimeout(() => {
			window.print();
			setTimeout(() => {
				container.remove();
				style.remove();
			}, 1000);
		}, 300);
	}
}
